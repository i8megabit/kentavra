# Kentavra v1.2.1 - Оркестратор для Akvorado

Этот оркестратор предоставляет набор инструментов для управления платформой мониторинга сетевого трафика Akvorado, упрощая установку, настройку и диагностику.

## Структура

- `run` - Основной скрипт-оркестратор, обеспечивающий весь функционал управления
- `env` - Файл с переменными окружения и конфигурацией
- `check` - Скрипт диагностики для проверки состояния системы

> **Примечание**: История изменений оркестратора ведётся в файле [CHANGELOG.md](../CHANGELOG.md) в корне проекта.

## Возможности

- **Установка**: автоматизированная установка и первичная настройка Akvorado
- **Управление**: запуск, остановка и перезапуск всех компонентов системы
- **Диагностика**: проверка состояния, просмотр логов и расширенная диагностика
- **Исправление проблем**: автоматическое исправление распространенных проблем
- **Работа с данными**: управление Kafka топиками, запросы к ClickHouse
- **Настройка**: отключение демо-режима

## Быстрый старт

1. Убедитесь, что у вас установлен Docker и bash
2. Клонируйте репозиторий Kentavra. Внутри уже есть распакованны архив Akvorado. Сотрите или замените его на актуальный, выполнив инструкции по быстрому старту
3. Запустите скрипт установки: `./kentavra/run install`
4. После установки запустите сервисы: `./kentavra/run start`
5. Проверьте статус: `./kentavra/run status`

> **Примечание**: Скрипт установки не скачивает архив Akvorado, а настраивает существующую локальную копию репозитория.

## Команды

```
run [команда] [опции]
```

Доступные команды:

- `install` - Установка и настройка Akvorado
- `start` - Запуск всех сервисов
- `stop` - Остановка всех сервисов
- `restart` - Перезапуск всех сервисов
- `status` - Проверка состояния всех сервисов
- `logs [сервис]` - Просмотр логов
- `test [тип]` - Генерация тестовых данных (tcpdump, softflowd)
- `debug` - Запуск диагностики
- `fix [проблема]` - Исправление проблем
- `disable-demo` - Отключение демо-режима
- `enable-geoip` - Включение функциональности GeoIP
- `snmp-setup` - Настройка SNMP
- `db-query [запрос]` - Запросы к ClickHouse
- `kafka-topic [cmd]` - Управление топиками Kafka
- `clean` - Удаление всех данных

## Требования

- Docker
- bash
- curl (устанавливается автоматически при необходимости)
- conntrack (устанавливается автоматически при необходимости)

## Настройка боевого окружения

По умолчанию Akvorado может быть установлен с включенным демо-режимом, который генерирует тестовые данные. Для боевого окружения этот режим следует отключить:

```bash
# Отключение демо-режима и настройка боевого окружения
./run disable-demo
```

Эта команда:
1. Проверяет файл `.env` и закомментирует строку `COMPOSE_FILE=${COMPOSE_FILE}:docker/docker-compose-demo.yml`
2. Проверяет файл `config/akvorado.yaml` и закомментирует строку `demo-exporter: !include "demo.yaml"`
3. Предложит перезапустить сервисы для применения изменений

## Включение и настройка GeoIP

По умолчанию функциональность GeoIP отключена. Для включения географического обогащения данных:

```bash
# Включение GeoIP и настройка соответствующих компонентов
./run enable-geoip
```

Эта команда:
1. Раскомментирует пути к GeoIP базам данных в `config/akvorado.yaml` 
2. Активирует провайдера GeoIP в файле `.env`
3. Убедится, что параметр `optional: true` установлен для GeoIP
4. Предложит перезапустить оркестратор для применения изменений

> **Примечание**: По умолчанию используются базы IPinfo. Для использования MaxMind GeoIP вам потребуется получить лицензию и указать ваши учетные данные в `.env`.

## Диагностика и отладка

Для диагностики проблем с Akvorado:

```bash
# Базовая диагностика
./run debug

# Исправление проблем с DNS
./run fix dns

# Исправление проблем с JMX портами
./run fix jmx

# Исправление проблем приема NetFlow/sFlow
./run fix conntrack

# Исправление проблем с Kafka
./run fix kafka

# Исправление проблем с ClickHouse
./run fix clickhouse
```

## Доступные проблемы для исправления

```bash
# Проблемы с conntrack и приемом NetFlow/sFlow данных
./run fix conntrack

# Проблемы с ClickHouse
./run fix clickhouse

# Проблемы с DNS
./run fix dns

# Конфликт JMX портов
./run fix jmx

# Проблемы с Kafka
./run fix kafka
```

## Управление топиками Kafka

```bash
# Просмотр списка топиков
./run kafka-topic list

# Описание топика
./run kafka-topic describe flows

# Создание нового топика
./run kafka-topic create my-topic

# Просмотр сообщений из топика
./run kafka-topic consume flows
```

## Запросы к ClickHouse

```bash
# Просмотр доступных таблиц
./run db-query "SHOW TABLES FROM akvorado"

# Пример запроса
./run db-query "SELECT TimeReceived, SrcAddr, DstAddr, BytesIn FROM akvorado.flows LIMIT 10"
```

## Настройка SNMP

Для настройки мониторинга устройств через SNMP:

```bash
./run snmp-setup
```

## Тестирование

Для генерации тестовых данных или мониторинга сетевого трафика:

```bash
# Запуск tcpdump для мониторинга трафика
./run test tcpdump

# Запуск softflowd для генерации тестовых данных NetFlow
./run test softflowd
```

## Полный список команд

```bash
./run help
```

### Полное удаление данных

Для полного удаления всех данных Akvorado, включая все контейнеры, тома и сети Docker:

```bash
./run clean
```

Эта команда выполняет следующие шаги в последовательности:
1. Запрашивает подтверждение перед удалением данных
2. Останавливает все контейнеры, связанные с Akvorado (исключая Portainer)
3. Последовательно удаляет каждый контейнер Akvorado по отдельности
4. Выполняет дополнительную проверку на наличие Redis и Traefik контейнеров
5. Находит и удаляет остановленные контейнеры, которые могут блокировать тома
6. Последовательно удаляет каждый том Docker, связанный с Akvorado
7. При обнаружении блокирующих контейнеров автоматически находит и удаляет их
8. Удаляет все сети Docker, связанные с Akvorado
9. Проводит финальную проверку на наличие неудаленных контейнеров и томов

> **Особенности**:
> - Контейнер Portainer не затрагивается процессом очистки
> - Контейнеры Redis и Traefik, связанные с Akvorado, удаляются даже при нестандартных именах
> - После очистки выполняется диагностика для подтверждения полного удаления

> **Внимание!** Эта операция приведет к полной потере всех данных и конфигураций Akvorado. Используйте с осторожностью.